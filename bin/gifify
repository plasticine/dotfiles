#!/usr/bin/env bash
#
# Compress video files into GIFs.
#
# Requirements:
#   - ffmpeg
#   - imagemagick
#   - terminal-notifier
#   - gifsicle
#
# Installing requirements:
#   brew install ffmpeg imagemagick terminal-notifier gifsicle

set -eo pipefail

gifsicle_bin="/opt/boxen/homebrew/bin/gifsicle"
notifier_bin="/opt/boxen/homebrew/bin/terminal-notifier"
ffmpeg_bin="/opt/boxen/homebrew/bin/ffmpeg"
convert_bin="/opt/boxen/homebrew/bin/convert"
tmpdir=$(mktemp -d /tmp/gifify.XXXXXXX)

notify() {
  $notifier_bin -title "Gifify" -subtitle "$1" -message "$2"
}

dump() {
  $ffmpeg_bin -i "$1" -r 10 -vcodec png "$tmpdir/frame-%05d.png"
}

convert() {
  $convert_bin -verbose +dither -layers Optimize -resize 800x800 "$tmpdir/frame*.png" "$tmpdir/output.gif"
}

optimize() {
  local filters="fps=60,scale=1024:-1:flags=lanczos"

  $ffmpeg_bin -v warning -i "$tmpdir/output.gif" -vf "$filters,palettegen" -y "$tmpdir/palette.png"
  $ffmpeg_bin -v warning -i "$tmpdir/output.gif" -i "$tmpdir/palette.png" -lavfi "$filters [x]; [x][1:v] paletteuse" -y "$tmpdir/output.gif"
}

compress() {
  $gifsicle_bin --colors 128 --delay=5 --loop --optimize=4 --output="$tmpdir/output.gif" "$tmpdir/output.gif"
}

cleanup() {
  rm -rf "$tmpdir"
}

main() {
  trap cleanup EXIT
  local input_path="$1"
  local output_path="$1.gif"

  {
    time(
      notify "Converting to GIF..." "$input_path"
      dump $input_path
      convert
      optimize
      compress
      notify "All done!" "$input_path"
      mv "$tmpdir/output.gif" "$output_path"
    )
  } 2>&1
}

main $1
