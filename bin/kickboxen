#!/usr/bin/env bash
#
# Keeps track of how often you run boxen

set -e

red=`tput setaf 1`
yellow=`tput setaf 3`
green=`tput setaf 2`
reset=`tput sgr0`

timestamp_file=$HOME/.boxen_timestamp
timestamp_format="%Y-%m-%d %H:%M:%S"
now="$(/bin/date -ju "+$timestamp_format")"

info() {
  printf "$@"
}

ok() {
  printf "${green}$@${reset}"
}


warn() {
  printf "${yellow}$@${reset}"
}

error() {
  printf "${red}$@${reset}"
}

one_week_ago() {
  /bin/date -juf "$timestamp_format" "$now" "+$timestamp_format" -v-7d
}

to_timestamp() {
  /bin/date -j -f "$timestamp_format" "$1" "+%s"
}

update_boxen_last_executed() {
  local boxen_exit_code="$1"

  info "Updating boxen last run date"
  echo "$now" > "$timestamp_file"
  ok " [OK]"
  echo ""
}

boxen_last_executed() {
  to_timestamp "$(cat "$timestamp_file")"
}

handle_skip() {
  local last_run=$(distance_of_time_in_words "$(boxen_last_executed)" "$(date -u +%s)")
  info "Boxen last invoked $last_run"
  exit 0
}

run_boxen() {
  boxen --stealth
  update_boxen_last_executed $?
}

handle_never_run() {
  warn "OK, I'm not sure when you last ran Boxen (maybe you never have?), so I'm Just gonna go ahead and take care of that for you! :)"
}

handle_needs_run() {
  warn "It looks like it has been quite a while since you last ran boxen!\n"
  read -p "Do you want to run it now (y/n)? " -n 1 -r
  if [[ $REPLY =~ ^[Yy]$ ]]
  then
    echo
    run_boxen
  fi
}

distance_of_time_in_words() {
  local start_timestamp="$1"
  local end_timestamp="$2"
  local diff=$(expr $end_timestamp - $start_timestamp)
  local seconds=$((diff % 60))
  local diff=$((diff / 60))
  local minutes=$((diff % 60))
  local diff=$((diff / 60))
  local hours=$((diff % 24))
  local diff=$((diff / 24))
  local days=$diff

  echo "$days days, $hours hours ago...\n"
}

main() {
  local last_run=$(boxen_last_executed)
  local threshold=$(to_timestamp "$(one_week_ago)")

  if [ ! -f "$timestamp_file" ]; then
    handle_never_run
  elif [ "$threshold" -lt "$last_run" ]; then
    handle_skip
  elif [ "$threshold" -gt "$last_run" ]; then
    handle_needs_run
  fi
}

main
